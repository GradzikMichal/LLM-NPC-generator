name: workflow.yml
on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches: ["main"]
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v5
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Ollama installation
        run: curl -LO https://ollama.com/download/ollama-linux-amd64.tgz; sudo rm -rf /usr/lib/ollama; sudo tar -C /usr -xzf ollama-linux-amd64.tgz
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Creating user for Ollama
        run: sudo useradd -r -s /bin/false -U -m -d /usr/share/ollama ollama; sudo usermod -a -G ollama $(whoami)
      - name: Creating daemon file
        uses: 1arp/create-a-file-action@0.4.5
        with:
          path: '/etc/systemd/system'
          isAbsolutePath: False
          file: 'ollama.service'
          content: |
            [Unit]
            Description=Ollama Service
            After=network-online.target
            
            [Service]
            ExecStart=/usr/bin/ollama serve
            User=ollama
            Group=ollama
            Restart=always
            RestartSec=3
            Environment="PATH=$PATH"
            
            [Install]
            WantedBy=multi-user.target
      - name: Running Ollama
        run: sudo systemctl daemon-reload; sudo systemctl enable ollama
      - name: Model run
        run: python src/main.py -s ../docs/fantasy.md --model_args num_ctx=1024, repeat_last_n=-1
